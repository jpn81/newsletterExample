<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Article</title>
  <style>
    :root{--brand:#081A35;--text:#0f172a;--muted:#475569;--line:#e5e7eb;--bg:#fff}
    .page{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Noto Sans,"Apple Color Emoji","Segoe UI Emoji";color:var(--text);background:var(--bg)}
    .wrap{max-width:860px;margin:0 auto;padding:22px}
    .back{display:inline-flex;gap:8px;align-items:center;margin-bottom:10px}
    .back a{color:var(--brand);text-decoration:none;border:1px solid var(--line);padding:6px 10px;border-radius:10px;background:#fff}
    .back a:hover{box-shadow:0 1px 6px rgba(0,0,0,.08)}
    h1{margin:.2rem 0 .5rem;font-size:clamp(1.6rem,1rem+2vw,2.2rem)}
    .meta{display:flex;gap:10px 14px;flex-wrap:wrap;color:var(--muted)}
    .hero{margin:14px 0 18px}
    .hero img{width:100%;height:auto;display:block;border-radius:12px;border:1px solid var(--line);object-fit:cover}
    .body{display:grid;gap:14px}
    .body p{margin:0;line-height:1.7}
    .body h2{margin:12px 0 2px;font-size:1.25rem}
    .body h3{margin:10px 0 0;font-size:1.1rem}
    .body blockquote{margin:0;padding:10px 12px;border-left:4px solid var(--brand);background:#f8fafc;border-radius:6px}
    .inline-img{border:1px solid var(--line);border-radius:10px;overflow:hidden}
    .inline-img img{width:100%;display:block}
    .inline-img figcaption{padding:8px 10px;color:var(--muted);font-size:.9rem}
  </style>
</head>
<body class="page">
  <main class="wrap" id="app" aria-busy="true">
    <div class="back"><a id="backLink" href="/newsletter/">← Back to Newsletter</a></div>
    <article id="article" hidden>
      <header>
        <h1 id="title">Loading…</h1>
        <div class="meta">
          <time id="date"></time>
          <span id="cats"></span>
        </div>
        <div class="hero"><img id="hero" alt=""></div>
      </header>
      <section id="content" class="body"></section>
    </article>
  </main>

  <script>
    (async function(){
      const params = new URLSearchParams(location.search);
      const slug = params.get('slug');
      const ref = params.get('ref') || '';
      const FALLBACK = '/newsletter/_common/assets/fallback.jpg';
      const back = document.getElementById('backLink');
      back.href = '/newsletter/' + (ref ? ('?'+ref) : '');

      if(!slug){
        document.getElementById('app').innerHTML = '<p>Missing article slug.</p>';
        return;
      }

      const jsonUrl = `/newsletter/articles/${encodeURIComponent(slug)}/article.json`;
      try {
        const res = await fetch(jsonUrl, {cache:'no-cache'});
        const data = await res.json();

        document.title = data.title || 'Article';

        // Header
        document.getElementById('title').textContent = data.title || 'Untitled';
        if (data.date){
          const d = new Date(data.date);
          document.getElementById('date').textContent = d.toLocaleDateString();
          document.getElementById('date').setAttribute('datetime', data.date);
        }
        document.getElementById('cats').innerHTML = (data.categories||[]).map(c=>`<span>• ${c}</span>`).join(' ');

        // Hero
        const hero = document.getElementById('hero');
        hero.src = (data.hero && data.hero.image) || FALLBACK;
        hero.alt = (data.hero && data.hero.alt) || 'Article image';
        hero.onerror = () => { hero.onerror=null; hero.src = FALLBACK; };

        // Body (supports simple blocks)
        const body = document.getElementById('content');
        const blocks = data.body || [];
        body.innerHTML = blocks.map(b=>{
          switch(b.type){
            case 'p': return `<p>${b.text||''}</p>`;
            case 'h2': return `<h2>${b.text||''}</h2>`;
            case 'h3': return `<h3>${b.text||''}</h3>`;
            case 'blockquote': return `<blockquote>${b.text||''}</blockquote>`;
            case 'ul': return `<ul>${(b.items||[]).map(i=>`<li>${i}</li>`).join('')}</ul>`;
            case 'ol': return `<ol>${(b.items||[]).map(i=>`<li>${i}</li>`).join('')}</ol>`;
            case 'img': {
              const src = b.src || FALLBACK;
              const alt = b.alt || '';
              const cap = b.caption ? `<figcaption>${b.caption}</figcaption>` : '';
              return `<figure class="inline-img"><img src="${src}" alt="${alt}" onerror="this.onerror=null;this.src='${FALLBACK}'" />${cap}</figure>`;
            }
            case 'code': {
              const lang = b.lang || '';
              return `<pre aria-label="${lang} code"><code>${(b.code||'')
                .replace(/&/g,'&amp;').replace(/</g,'&lt;')}</code></pre>`;
            }
            default: return '';
          }
        }).join('');

        document.getElementById('article').hidden = false;
        document.getElementById('app').setAttribute('aria-busy','false');
      } catch (e){
        document.getElementById('app').innerHTML = `<p>Could not load this article.</p>`;
        console.error('Article load error', e);
      }
    })();
  </script>
</body>
</html>
