<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Newsletter — Latest Articles</title>
  <style>
    :root{--brand:#081A35;--text:#0f172a;--muted:#475569;--line:#e5e7eb;--card:#fff;--bg:#fff}
    .nl{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Noto Sans,"Apple Color Emoji","Segoe UI Emoji";color:var(--text);background:var(--bg)}
    .wrap{max-width:940px;margin:0 auto;padding:24px}
    h1{margin:0 0 8px;font-size:clamp(1.6rem,1rem+2vw,2.2rem)}
    .sub{color:var(--muted);margin:0 0 16px}
    .grid{display:grid;gap:16px}
    .card{display:grid;grid-template-columns:120px 1fr;gap:14px;border:1px solid var(--line);border-radius:12px;background:var(--card);padding:12px;align-items:center}
    .thumb{width:100%;aspect-ratio:16/10;object-fit:cover;border-radius:8px;border:1px solid var(--line);background:#f8fafc}
    .meta{display:flex;gap:8px;flex-wrap:wrap;color:var(--muted);font-size:.9rem;margin:4px 0}
    .title{margin:0 0 4px;font-size:1.1rem;line-height:1.35}
    .excerpt{margin:0 0 10px;color:#111827;line-height:1.55}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;text-decoration:none;color:var(--brand);font-weight:600}
    .btn:hover{box-shadow:0 1px 6px rgba(0,0,0,.08)}
    .pill{border:1px dashed var(--line);border-radius:999px;padding:4px 10px;font-size:.85rem;color:var(--muted)}
    .err{margin-top:12px;padding:10px;border:1px solid #fecaca;background:#fff1f2;border-radius:8px}
    @media (max-width:580px){.card{grid-template-columns:1fr}.thumb{max-height:220px}}
  </style>
</head>
<body class="nl">
  <main class="wrap" id="app" aria-busy="true">
    <h1>Newsletter</h1>
    <p class="sub">Latest articles, newest first.</p>
    <div id="list" class="grid" role="list"></div>
    <div id="error" class="err" hidden></div>
  </main>

  <script>
    (async function(){
      const $list = document.getElementById('list');
      const $err  = document.getElementById('error');

      // Directory of THIS page, e.g. /group/guest/newsletter/
      const HERE = new URL('.', location.href);
      const basePath = HERE.pathname.endsWith('/') ? HERE.pathname : HERE.pathname + '/';

      // Fallback image candidates (try relative first, then absolute-ish backup)
      const FALLBACKS = [
        basePath + '_common/assets/fallback.jpg',
        '/newsletter/_common/assets/fallback.jpg'
      ];

      // Try a list of JSON URLs until one works
      async function loadJSON(candidates){
        for (const url of candidates){
          try{
            const res = await fetch(url, { cache: 'no-cache' });
            if (res.ok) return await res.json();
          }catch(e){ /* continue */ }
        }
        throw new Error('All JSON candidates failed: ' + candidates.join(', '));
      }

      // If JSON is blocked by host, load a JS manifest that sets window.NEWS_MANIFEST
      async function loadJSManifest(candidates){
        for (const url of candidates){
          try{
            await new Promise((resolve, reject)=>{
              const s = document.createElement('script');
              s.src = url + (url.includes('?') ? '&' : '?') + 'v=' + Date.now();
              s.onload = ()=> resolve();
              s.onerror = ()=> reject();
              document.head.appendChild(s);
            });
            if (Array.isArray(window.NEWS_MANIFEST)) return window.NEWS_MANIFEST;
          }catch(e){ /* try next */ }
        }
        throw new Error('All JS manifest candidates failed: ' + candidates.join(', '));
      }

      // Resolve the first working fallback image on error (can try multiple)
      window.__imgFallback = function(img){
        const list = (img.dataset.fallback || '').split('|').filter(Boolean);
        if (list.length){
          img.onerror = null;     // stop infinite loops
          img.src = list.shift(); // try next
          img.dataset.fallback = list.join('|');
        }
      };

      try {
        // primary: JSON; secondary: JS
        const manifestJSONPaths = [
          basePath + 'articles/manifest.json',
          basePath + '/articles/manifest.json',
          '/newsletter/articles/manifest.json'
        ];
        const manifestJSPaths = [
          basePath + 'articles/manifest.js',
          basePath + '/articles/manifest.js',
          '/newsletter/articles/manifest.js'
        ];

        let items;
        try {
          items = await loadJSON(manifestJSONPaths);
        } catch {
          items = await loadJSManifest(manifestJSPaths);
        }

        // sort newest → oldest (expects YYYY-MM-DD)
        items.sort((a,b)=> (b.date || '').localeCompare(a.date || ''));

        // preserve any inbound query (so Back link in article can return with it)
        const ref = location.search ? '&ref=' + encodeURIComponent(location.search.slice(1)) : '';

        $list.innerHTML = items.map(it => {
          const slug = it.slug || '';
          // Allow manifest to omit "image" — we assume /articles/<slug>/assets/hero.jpg
          const defaultImg = basePath + 'articles/' + encodeURIComponent(slug) + '/assets/hero.jpg';
          const img = it.image || defaultImg;

          const dateStr = it.date ? new Date(it.date).toLocaleDateString() : '';
          const cats = (it.categories||[]).map(c=>`<span class="pill">${c}</span>`).join(' ');
          const url = basePath + 'article.html?slug=' + encodeURIComponent(slug) + ref;

          const fallbacksPipe = [img, ...FALLBACKS].join('|');

          return `
            <article class="card" role="listitem">
              <img class="thumb"
                   src="${img}"
                   alt="${it.imageAlt || 'Article image'}"
                   data-fallback="${fallbacksPipe}"
                   onerror="window.__imgFallback(this)" />
              <div>
                <h2 class="title">${it.title || 'Untitled'}</h2>
                <div class="meta">
                  ${dateStr ? `<time datetime="${it.date}">${dateStr}</time>` : ''}
                  ${cats}
                </div>
                <p class="excerpt">${it.excerpt || ''}</p>
                <div class="row">
                  <a class="btn" href="${url}">Read more</a>
                </div>
              </div>
            </article>
          `;
        }).join('');

        document.getElementById('app').setAttribute('aria-busy','false');
      } catch (e){
        $list.innerHTML = '';
        $err.hidden = false;
        $err.textContent = 'Could not load articles. Check manifest.json or manifest.js paths. ' + e.message;
        console.error(e);
      }
    })();
  </script>
</body>
</html>
